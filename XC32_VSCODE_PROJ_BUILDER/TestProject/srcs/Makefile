# Makefile for TestProject - Generated by PIC32MZ Project Builder
DFP_DIR := $(DFP)
DFP_INCLUDE := $(DFP)/include

# Source files (current directory and peripheral subdirectories)
SRCS := $(wildcard *.c) $(wildcard peripheral/*/*.c)
OBJS := $(SRCS:%.c=../objs/%.o)

# Assembly files in startup directory
ASM_SRCS := $(wildcard startup/*.S)
ASM_OBJS := $(ASM_SRCS:%.S=../objs/%.o)
OBJS += $(ASM_OBJS)

# Compiler and flags
CC := "$(COMPILER_LOCATION)/xc32-gcc"
MCU := -mprocessor=$(DEVICE)
FLAGS := -Werror -Wall -MP -MMD -g -O1 -ffunction-sections -fdata-sections -fno-common

# Include directories
INCS := -I"../incs" -I"$(DFP_INCLUDE)" -I"../incs/peripheral"

# Linker script
LINKER_SCRIPT := "$(DFP)/xc32/$(DEVICE)/p32mZ1024EFH064.ld"

# Default target
../bins/$(MODULE): $(OBJS)
	@echo "Linking $(MODULE) for $(DEVICE)"
	$(CC) $(MCU) -nostartfiles -DXPRJ_default=default -mdfp="$(DFP)" -Wl,--script=$(LINKER_SCRIPT) -Wl,--defsym=__MPLAB_BUILD=1 -Wl,-Map="../other/$(MODULE).map" -o $@ $^

# Compile C source files
../objs/%.o: %.c
	@echo "Compiling $< to $@"
	@mkdir -p $(dir $@)
	$(CC) -x c -c $(MCU) $(FLAGS) $(INCS) -DXPRJ_default=default -mdfp="$(DFP)" -MF $(@:.o=.d) $< -o $@

# Compile assembly files

../objs/%.o: %.S
	@echo "Compiling assembly $< to $@"
	@mkdir -p $(dir $@)
	$(CC) $(MCU) -c -DXPRJ_default=default -Wa,--defsym=__MPLAB_BUILD=1,--gdwarf-2 -mdfp="$(DFP)" -MMD -MF $(@:.o=.d) $< -o $@

build_dir:
	@mkdir -p ../objs ../bins ../other ../objs/peripheral ../objs/startup

clean:
	@rm -rf ../objs/* ../bins/* ../other/*

.PHONY: build_dir clean
